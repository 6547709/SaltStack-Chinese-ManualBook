# Getting Started With VMware

*New in version 2015.5.4.*

Author: Nitin Madhok <nmadhok@clemson.edu>

VMware云模块允许您管理VMware ESX，ESXi和vCenter。

## Dependencies - 依赖关系

Salt Cloud的vmware模块需要`pyVmomi`软件包，该软件包可从PyPI获得：

https://pypi.python.org/pypi/pyvmomi

可以使用 `pip` 或 `easy_install`安装该软件包:
```bash
pip install pyvmomi
easy_install pyvmomi
```

> 注意
>
> pyVmomi 6.0版在某些Python版本上存在SSL错误处理方面的问题。 如果使用的是pyVmomi 6.0版，则运行proxy minion进程的计算机必须具有Python 2.7.9或更高版本。这是由于pyVmomi 6.0中存在上游依赖性，Python 2.6到2.7.8版本不支持该依赖性。 如果运行salt-cloud命令的Python版本不在支持的范围内，则需要安装pyVmomi的早期版本。 有关更多信息，请参见问题[＃29537](https://github.com/saltstack/salt/issues/29537)。

> 注意
>
> 当连接到VMware时，pyVmomi没有提供指定语言环境的功能。 连接到在非英语语言环境下运行的VMware实例时，这会导致解析问题。 在添加此功能之前，上游[＃38402问题](https://github.com/saltstack/salt/issues/38402)包含一种解决方法。

## Configuration - 配置说明

VMware云模块需要在`/etc/salt/cloud.providers`或`/etc/salt/cloud.providers.d/vmware.conf`的云平台provider驱动程序配置中设置vCenter或ESX/ESXi URL、user和password：
```yaml
my-vmware-config:
  driver: vmware
  user: 'DOMAIN\user'
  password: 'verybadpass'
  url: '10.20.30.40'

vcenter01:
  driver: vmware
  user: 'DOMAIN\user'
  password: 'verybadpass'
  url: 'vcenter01.domain.com'
  protocol: 'https'
  port: 443

vcenter02:
  driver: vmware
  user: 'DOMAIN\user'
  password: 'verybadpass'
  url: 'vcenter02.domain.com'
  protocol: 'http'
  port: 80

esx01:
  driver: vmware
  user: 'admin'
  password: 'verybadpass'
  url: 'esx01.domain.com'
```

> 注意
>
> 可选地，如果vCenter Server服务未使用默认值，则可以指定`protocol`和`port`。 默认值为协`protocol: https` 和 `port: 443`。

> 注意
>
> *Changed in version 2015.8.0.*
>
> 云平台provider定义中的`provider`参数已重命名为`driver`。 进行此更改是为了避免与云平台profile配置文件定义中使用的`provider`参数混淆。 现在，云平台provider定义中使用`driver`来引用提供连接至云主机的基础功能的Salt云模块，而云主机profile配置文件则继续使用`provider`来引用您定义的provider配置。

## Profiles - 云主机配置

在 `/etc/salt/cloud.profiles` 或 `/etc/salt/cloud.profiles.d/vmware.conf`中设置云主机的初始化配置:
```yaml
vmware-centos6.5:
  provider: vcenter01
  clonefrom: test-vm

  ## Optional arguments
  num_cpus: 4
  memory: 8GB
  devices:
    cd:
      CD/DVD drive 1:
        device_type: datastore_iso_file
        iso_path: "[nap004-1] vmimages/tools-isoimages/linux.iso"
      CD/DVD drive 2:
        device_type: client_device
        mode: atapi
        controller: IDE 2
      CD/DVD drive 3:
        device_type: client_device
        mode: passthrough
        controller: IDE 3
    disk:
      Hard disk 1:
        size: 30
      Hard disk 2:
        size: 20
        controller: SCSI controller 2
      Hard disk 3:
        size: 5
        controller: SCSI controller 3
        datastore: smalldiskdatastore
    network:
      Network adapter 1:
        name: 10.20.30-400-Test
        switch_type: standard
        ip: 10.20.30.123
        gateway: [10.20.30.110]
        subnet_mask: 255.255.255.128
        domain: example.com
      Network adapter 2:
        name: 10.30.40-500-Dev-DHCP
        adapter_type: e1000
        switch_type: distributed
        mac: '00:16:3e:e8:19:0f'
      Network adapter 3:
        name: 10.40.50-600-Prod
        adapter_type: vmxnet3
        switch_type: distributed
        ip: 10.40.50.123
        gateway: [10.40.50.110]
        subnet_mask: 255.255.255.128
        domain: example.com
    scsi:
      SCSI controller 1:
        type: lsilogic
      SCSI controller 2:
        type: lsilogic_sas
        bus_sharing: virtual
      SCSI controller 3:
        type: paravirtual
        bus_sharing: physical
    ide:
      IDE 2
      IDE 3

  domain: example.com
  dns_servers:
    - 123.127.255.240
    - 123.127.255.241
    - 123.127.255.242

  resourcepool: Resources
  cluster: Prod

  datastore: HUGE-DATASTORE-Cluster
  folder: Development
  datacenter: DC1
  host: c4212n-002.domain.com
  template: False
  power_on: True
  extra_config:
    mem.hotadd: 'yes'
    guestinfo.foo: bar
    guestinfo.domain: foobar.com
    guestinfo.customVariable: customValue
  annotation: Created by Salt-Cloud

  deploy: True
  customization: True
  private_key: /root/.ssh/mykey.pem
  ssh_username: cloud-user
  password: veryVeryBadPassword
  minion:
    master: 123.127.193.105

  file_map:
    /path/to/local/custom/script: /path/to/remote/script
    /path/to/local/file: /path/to/remote/file
    /srv/salt/yum/epel.repo: /etc/yum.repos.d/epel.repo

  hardware_version: 10
  image: centos64Guest

  #For Windows VM
  win_username: Administrator
  win_password: administrator
  win_organization_name: ABC-Corp
  plain_text: True
  win_installer: /root/Salt-Minion-2015.8.4-AMD64-Setup.exe
  win_user_fullname: Windows User
```

1. provider

 云提供商配置文件中定义的provider服务的名称。
2. clonefrom

 输入要从中克隆的VM/模板的名称。 如果未指定，将创建虚拟机而不进行克隆。
3. num_cpus

 输入您希望虚拟机/模板具有的vCPUS的数量。 如果未指定，则使用当前VM/模板的vCPU计数。
4. cores_per_socket

 输入您希望VM/模板具有的每个vCPU的核心数。 如果未指定，则默认为1。

 > 注意:  每个socket的核心数应小于或等于分配给VM/模板的vCPU总数。

 *New in version 2016.11.0.*
5. memory

 输入您要VM/模板拥有的内存大小（以MB或GB为单位）。 如果未指定，则使用当前VM/模板的内存大小。 示例内存：8GB或内存：8192MB。
6. devices

 在此处输入设备规格。 当前，可以创建或重新配置以下设备：

 - **cd**

    在此处输入CD/DVD驱动器规格。 如果CD/DVD驱动器不存在，将使用指定的配置进行创建。 如果CD/DVD驱动器已经存在，它将按照规格进行重新配置。 可以为每个CD/DVD驱动器指定以下选项：
    - device_type

      指定如何使用CD/DVD驱动器。 当前支持的类型是`client_device`和`datastore_iso_file`。 默认值为`device_type: client_device`。
    - iso_path

      仅当设置`device_type: datastore_iso_file`时，需要输入数据存储中的iso文件的路径。 指定此参数的语法为`iso_path: "[datastoreName] vmimages/tools-isoimages/linux.iso"`。 如果设置为 `device_type: client_device`，则忽略此字段。
    - mode

      仅在设置为`device_type: client_device`时用于指定输入连接模式。 当前支持的模式是`passthrough`和`atapi`。 如果是设置为 `device_type: datastore_iso_file`，则忽略此字段。 默认为 `mode: passthrough` 。
    - controller

      指定该驱动器应附加到的IDE控制器标签。 仅在同时创建指定的IDE控制器和CD/DVD驱动器时才应指定此选项。

 - **disk**

    在此处输入磁盘规格。 如果硬盘不存在，则会以提供的size参数创建硬盘。 如果硬盘已经存在，并且所提供的大小大于当前磁盘的大小，则会对其进行扩展。

    - size

      输入磁盘大小（以GB为单位）。
    - thin_provision

      指定是否应该精简配置磁盘。 默认值为`thin_provision: False`。 ..versionadded:: 2016.3.0
    - eagerly_scrub

      指定在密集配置期间是否应使用zero重写磁盘。 默认值为`eagerly_scrub: False`。.. versionadded:: 2018.3.0
    - controller

      指定该磁盘应附加到的SCSI控制器标签。 仅在同时创建指定的SCSI控制器和硬盘时才应指定此选项。
    - datastore

      如果您希望新磁盘位于虚拟机的默认值之外的其他数据存储区中，则该参数为有效数据存储区的名称。

 - **network**

    在此处输入网络适配器规格。 如果网络适配器不存在，将使用指定的网络名称、类型和其他配置来创建新的网络适配器。 如果网络适配器已经存在，将使用规格进行重新配置。 可以为每个网络适配器指定以下附加选项（请参见上面的示例）：

    - name

      输入您要将网络适配器映射到的网络名称。
    - adapter_type

      输入您要创建的网络适配器类型。 当前支持的类型是`vmxnet`、`vmxnet2`、`vmxnet3`、`e1000`和`e1000e`。 如果未指定任何类型，则默认情况下将使用`vmxnet3`。
    - switch_type

      输入要使用的开关类型。 使用该参数决定使用标准交换网络还是分布式虚拟端口组。 当前支持的类型是标准端口组的`standard`类型，以及分布式虚拟端口组的`distributed`类型。
    - ip

      输入您要将网络适配器映射到的静态IP。 如果指定的网络启用了DHCP，则无需指定。
    - gateway

      输入一个列表形式的值作为网络网关。 如果指定的网络启用了DHCP，则无需指定。
    - subnet_mask

      输入网络的子网掩码。 如果指定的网络启用了DHCP，则无需指定。
    - domain

      输入要与网络适配器一起使用的域。 如果指定的网络启用了DHCP，则无需指定。
    - mac

      输入此网络适配器的MAC。 如果未指定，将自动选择一个地址。
 - **scsi**

    在此处输入SCSI控制器规格。 如果SCSI控制器不存在，将创建指定类型的新SCSI控制器。 如果SCSI控制器已经存在，它将使用规格进行重新配置。 可以为每个SCSI控制器指定以下附加选项：

    - type

      输入您要创建的SCSI控制器类型。 当前支持的类型是`lsilogic`、`lsilogic_sas`和`paravirtual`。 创建新的SCSI控制器时必须指定类型。
    - bus_sharing

      如果需要在虚拟机之间共享虚拟磁盘，请指定此选项。 可以指定以下内容：

      - virtual

        可以在同一服务器上的虚拟机之间共享虚拟磁盘。
      - physical

        可以在任何服务器上的虚拟机之间共享虚拟磁盘。
      - no

        虚拟磁盘不能在虚拟机之间共享。

 - **ide**

    在此处输入IDE控制器规格。 如果IDE控制器不存在，将创建一个新的IDE控制器。 如果IDE控制器已经存在，则不会对其进行任何进一步的更改。

7. domain

    Enter the global domain name to be used for DNS. If not specified and if the VM name is a FQDN, domain is set to the domain from the VM name. Default is local.
dns_servers

    Enter the list of DNS servers to use in order of priority.
resourcepool

    Enter the name of the resourcepool to which the new virtual machine should be attached. This determines what compute resources will be available to the clone.

    Note

        For a clone operation from a virtual machine, it will use the same resourcepool as the original virtual machine unless specified.

        For a clone operation from a template to a virtual machine, specifying either this or cluster is required. If both are specified, the resourcepool value will be used.

        For a clone operation to a template, this argument is ignored.

8. cluster

    Enter the name of the cluster whose resource pool the new virtual machine should be attached to.

    Note

        For a clone operation from a virtual machine, it will use the same cluster's resourcepool as the original virtual machine unless specified.

        For a clone operation from a template to a virtual machine, specifying either this or resourcepool is required. If both are specified, the resourcepool value will be used.

        For a clone operation to a template, this argument is ignored.

datastore

    Enter the name of the datastore or the datastore cluster where the virtual machine should be located on physical storage. If not specified, the current datastore is used.

    Note

        If you specify a datastore cluster name, DRS Storage recommendation is automatically applied.

        If you specify a datastore name, DRS Storage recommendation is disabled.

folder

    Enter the name of the folder that will contain the new virtual machine.

    Note

        For a clone operation from a VM/template, the new VM/template will be added to the same folder that the original VM/template belongs to unless specified.

        If both folder and datacenter are specified, the folder value will be used.

datacenter

    Enter the name of the datacenter that will contain the new virtual machine.

    Note

        For a clone operation from a VM/template, the new VM/template will be added to the same folder that the original VM/template belongs to unless specified.

        If both folder and datacenter are specified, the folder value will be used.

host

    Enter the name of the target host where the virtual machine should be registered.

    If not specified:

    Note

        If resource pool is not specified, current host is used.

        If resource pool is specified, and the target pool represents a stand-alone host, the host is used.

        If resource pool is specified, and the target pool represents a DRS-enabled cluster, a host selected by DRS is used.

        If resource pool is specified and the target pool represents a cluster without DRS enabled, an InvalidArgument exception be thrown.

template

    Specifies whether the new virtual machine should be marked as a template or not. Default is template: False.
power_on

    Specifies whether the new virtual machine should be powered on or not. If template: True is set, this field is ignored. Default is power_on: True.
extra_config

    Specifies the additional configuration information for the virtual machine. This describes a set of modifications to the additional options. If the key is already present, it will be reset with the new value provided. Otherwise, a new option is added. Keys with empty values will be removed.
annotation

    User-provided description of the virtual machine. This will store a message in the vSphere interface, under the annotations section in the Summary view of the virtual machine.
deploy

    Specifies if salt should be installed on the newly created VM. Default is True so salt will be installed using the bootstrap script. If template: True or power_on: False is set, this field is ignored and salt will not be installed.
wait_for_ip_timeout

    When deploy: True, this timeout determines the maximum time to wait for VMware tools to be installed on the virtual machine. If this timeout is reached, an attempt to determine the client's IP will be made by resolving the VM's name. By lowering this value a salt bootstrap can be fully automated for systems that are not built with VMware tools. Default is wait_for_ip_timeout: 1200.
customization

    Specify whether the new virtual machine should be customized or not. If customization: False is set, the new virtual machine will not be customized. Default is customization: True.
private_key

    Specify the path to the private key to use to be able to ssh to the VM.
ssh_username

    Specify the username to use in order to ssh to the VM. Default is root
password

    Specify a password to use in order to ssh to the VM. If private_key is specified, you do not need to specify this.
minion

    Specify custom minion configuration you want the salt minion to have. A good example would be to specify the master as the IP/DNS name of the master.
file_map

    Specify file/files you want to copy to the VM before the bootstrap script is run and salt is installed. A good example of using this would be if you need to put custom repo files on the server in case your server will be in a private network and cannot reach external networks.
hardware_version

    Specify the virtual hardware version for the vm/template that is supported by the host.
image

    Specify the guest id of the VM. For a full list of supported values see the VMware vSphere documentation:

    http://pubs.vmware.com/vsphere-60/topic/com.vmware.wssdk.apiref.doc/vim.vm.GuestOsDescriptor.GuestOsIdentifier.html

    Note

    For a clone operation, this argument is ignored.
win_username

    Specify windows vm administrator account.

    Note

    Windows template should have "administrator" account.
win_password

    Specify windows vm administrator account password.

    Note

    During network configuration (if network specified), it is used to specify new administrator password for the machine.
win_organization_name

    Specify windows vm user's organization. Default organization name is Organization

        VMware vSphere documentation:

    https://www.vmware.com/support/developer/vc-sdk/visdk25pubs/ReferenceGuide/vim.vm.customization.UserData.html
win_user_fullname

    Specify windows vm user's fullname. Default fullname is "Windows User"

        VMware vSphere documentation:

    https://www.vmware.com/support/developer/vc-sdk/visdk25pubs/ReferenceGuide/vim.vm.customization.UserData.html
plain_text

    Flag to specify whether or not the password is in plain text, rather than encrypted. VMware vSphere documentation:

    https://www.vmware.com/support/developer/vc-sdk/visdk25pubs/ReferenceGuide/vim.vm.customization.Password.html
win_installer

    Specify windows minion client installer path
win_run_once

    Specify a list of commands to run on first login to a windows minion

    https://www.vmware.com/support/developer/vc-sdk/visdk25pubs/ReferenceGuide/vim.vm.customization.GuiRunOnce.html

## Cloning a VM

Cloning VMs/templates is the easiest and the preferred way to work with VMs using the VMware driver.

Note

Cloning operations are unsupported on standalone ESXi hosts, a vCenter server will be required.

Example of a minimal profile:
```yaml
my-minimal-clone:
  provider: vcenter01
  clonefrom: 'test-vm'
```
When cloning a VM, all the profile configuration parameters are optional and the configuration gets inherited from the clone.

Example to add/resize a disk:
```yaml
my-disk-example:
  provider: vcenter01
  clonefrom: 'test-vm'

  devices:
    disk:
      Hard disk 1:
        size: 30
```
Depending on the configuration of the VM that is getting cloned, the disk in the resulting clone will differ.

Note

    If the VM has no disk named 'Hard disk 1' an empty disk with the specified size will be added to the clone.

    If the VM has a disk named 'Hard disk 1' and the size specified is larger than the original disk, an empty disk with the specified size will be added to the clone.

    If the VM has a disk named 'Hard disk 1' and the size specified is smaller than the original disk, an empty disk with the original size will be added to the clone.

Example to reconfigure the memory and number of vCPUs:
```yaml
my-disk-example:
  provider: vcenter01
  clonefrom: 'test-vm'

  memory: 16GB
  num_cpus: 8
```
## Cloning a Template

Cloning a template works similar to cloning a VM except for the fact that a resource pool or cluster must be specified additionally in the profile.

Example of a minimal profile:
```yaml
my-template-clone:
 provider: vcenter01
 clonefrom: 'test-template'
 cluster: 'Prod'
```
## Cloning from a Snapshot

New in version 2016.3.5.

Cloning from a snapshot requires that one of the supported options be set in the cloud profile.

Supported options are createNewChildDiskBacking, moveChildMostDiskBacking, moveAllDiskBackingsAndAllowSharing and moveAllDiskBackingsAndDisallowSharing.

Example of a minimal profile:
```yaml
my-template-clone:
  provider: vcenter01
  clonefrom: 'salt_vm'
  snapshot:
    disk_move_type: createNewChildDiskBacking
    # these types are also supported
    # disk_move_type: moveChildMostDiskBacking
    # disk_move_type: moveAllDiskBackingsAndAllowSharing
    # disk_move_type: moveAllDiskBackingsAndDisallowSharing
```
## Creating a VM

New in version 2016.3.0.

Creating a VM from scratch means that more configuration has to be specified in the profile because there is no place to inherit configuration from.

Note

Unlike most cloud drivers that use prepared images, creating VMs using VMware cloud driver needs an installation method that requires no human interaction. For Example: preseeded ISO, kickstart URL or network PXE boot.

Example of a minimal profile:
```yaml
my-minimal-profile:
  provider: esx01
  datastore: esx01-datastore
  resourcepool: Resources
  folder: vm
```
Note

The example above contains the minimum required configuration needed to create a VM from scratch. The resulting VM will only have 1 VCPU, 32MB of RAM and will not have any storage or networking.

Example of a complete profile:
```yaml
my-complete-example:
  provider: esx01
  datastore: esx01-datastore
  resourcepool: Resources
  folder: vm

  num_cpus: 2
  memory: 8GB

  image: debian7_64Guest

  devices:
    scsi:
      SCSI controller 0:
        type: lsilogic_sas
    ide:
      IDE 0: {}
      IDE 1: {}
    disk:
      Hard disk 0:
        controller: 'SCSI controller 0'
        size: 20
        mode: 'independent_nonpersistent'
    cd:
      CD/DVD drive 0:
        controller: 'IDE 0'
        device_type: datastore_iso_file
        iso_path: '[esx01-datastore] debian-8-with-preseed.iso'
    network:
      Network adapter 0:
        name: 'VM Network'
        swith_type: standard
```
Note

Depending on VMware ESX/ESXi version, an exact match for image might not be available. In such cases, the closest match to another image should be used. In the example above, a Debian 8 VM is created using the image debian7_64Guest which is for a Debian 7 guest.

## Specifying disk backing mode

New in version 2016.3.5.

Disk backing mode can now be specified when cloning a VM. This option can be set in the cloud profile as shown in example below:
```yaml
my-vm:
  provider: esx01
  datastore: esx01-datastore
  resourcepool: Resources
  folder: vm


  devices:
    disk:
      Hard disk 1:
        mode: 'independent_nonpersistent'
        size: 42
      Hard disk 2:
        mode: 'independent_nonpersistent'
```

https://docs.saltstack.com/en/latest/topics/cloud/vmware.html
