# Pillar Walkthrough - Pillar 实战演练
+ [Setting Up Pillar](#SETTING-UP-PILLAR)
  - [More Complex Data](#MORE-COMPLEX-DATA)
+ Parameterizing States With Pillar
+ Pillar Makes Simple States Grow Easily
+ Setting Pillar Data on the Command Line
+ More On Pillar
+ Minion Config in Pillar

> 注：本演练假定读者已经完成了最初的[Salt演练](https://docs.saltstack.com/en/latest/topics/tutorials/walkthrough.html#tutorial-salt-walk-through)。

Pillar是在Salt Master上定义的树状数据结构，并传递给minions使用。 它们允许将机密的或有针对性的数据安全地发送给相关的minions。

> 注：Grains和Pillar有时会混淆，只需要记住这一点，Grains是关于一个minion的信息，是一份由minion负责储存或生成的数据。 这就是为什么在Grains中可以找到OS和CPU类型等信息的原因。 Pillar是在Salt Master上存储或生成的关于minion或许多minions的信息。

**Pillar 的典型使用场景有：**
- 高度敏感的数据: 通过pillar传输的信息保证仅提供给目标对象，使Pillar适合管理安全信息，如加密密钥和密码。
- Minion 配置: Minion模块，例如执行模块、状态和returners之类的通常可以通过存储在pillar中的数据来配置。
- 使用变量: 需要分配给特定minions或minions组的变量可以在pillar中定义，然后在sls公式和模板文件中访问。
- 任意数据: Pillar可以包含字典格式的任何基本数据结构，因此可以定义一组键/值存储，然后在sls公式中轻松迭代它。

因此，Pillar是使用Salt时最重要的系统之一。 本演练旨在让Pillar在几分钟内启动并运行，然后深入了解Pillar的功能以及可用的数据存放位置。


## SETTING UP PILLAR
默认情况下，pillar已经在Salt中运行。 查看minion的pillar数据的方法是：
```bash
salt '*' pillar.items
```

> 注：在版本0.16.2之前，此函数名为`pillar.data`。 此功能名称仍支持向后兼容性。

默认情况下，master配置文件的内容不会加载到minions的pillar中。 这可以通过`pillar_opts`设置，该选项默认为`False`。

Master配置文件的内容可用于配置minion的pillar文件。 这使得对服务和系统的全局配置变得非常容易，但请注意，如果在master配置文件中存储了敏感数据，则可能不适合这样做。 要使master配置文件内容可用于minion的pillar文件，请在minion配置文件中将`pillar_opts`设置为`True`。

与state状态树类似，pillar由sls文件组成，并具有top file文件。 Pillar文件的默认存放位置是/srv/pillar。

> 注：可以通过master配置文件中的`pillar_roots`选项配置pillar文件的位置。 但它不能位于state状态树或`file_roots`的子目录中。 如果pillar位于`file_roots`之下，任何pillar目标都会被minions跳过。

现在开始配置pillar，确认`/srv/pillar`目录已经创建好了：
```bash
mkdir /srv/pillar
```
创建一个简单的top file文件，其格式与state状态使用的top file文件相同：

`/srv/pillar/top.sls`:
```yaml
base:
  '*':
    - data
```
在这个top.sls文件中将data.sls文件与所有minions进行了关联。

现在需要填充`/srv/pillar/data.sls`文件：

`/srv/pillar/data.sls`:
```yaml
info: some data
```
为了确保minions拥有新的pillar数据，向他们发出命令，要求他们从master那里获取并刷新他们的pillar数据：
```bash
salt '*' saltutil.refresh_pillar
```
现在，在minions侧就已经有了更新后的pillar数据了，可以通过下面的方法访问到：
```bash
salt '*' pillar.items
```
我们定义的key `info` 现在应该出现在返回的pillar数据中了。


### MORE COMPLEX DATA

https://docs.saltstack.com/en/latest/topics/tutorials/pillar.html#more-complex-data

Unlike states, pillar files do not need to define formulas. This example sets up user data with a UID:

/srv/pillar/users/init.sls:

users:
  thatch: 1000
  shouse: 1001
  utahdave: 1002
  redbeard: 1003
Note

The same directory lookups that exist in states exist in pillar, so the file users/init.sls can be referenced with users in the top file.

The top file will need to be updated to include this sls file:

/srv/pillar/top.sls:

base:
  '*':
    - data
    - users
Now the data will be available to the minions. To use the pillar data in a state, you can use Jinja:

/srv/salt/users/init.sls

{% for user, uid in pillar.get('users', {}).items() %}
{{user}}:
  user.present:
    - uid: {{uid}}
{% endfor %}
This approach allows for users to be safely defined in a pillar and then the user data is applied in an sls file.






https://docs.saltstack.com/en/latest/topics/tutorials/pillar.html
