# RETURNERS

默认情况下，发送给Salt minions的命令的返回值将返回给Salt master，但是我们还可以很多其它的方式来使用这份结果数据。

通过使用Salt returner，可以将结果数据重定向到外部数据存储服务以做进一步的分析和归档。

Returners从Salt minions中提取它们的配置信息，且仅支持在程序起动时加载一次配置信息。

Returners接口允许将返回数据发送到可以接收数据的任何系统。 这意味着可以将返回数据发送到Redis服务器，MongoDB服务器，MySQL服务器或任何系统。

> 更多returners参见 [Full list of builtin returners](https://docs.saltstack.com/en/latest/ref/returners/all/index.html#all-salt-returners)

## USING RETURNERS
所有Salt命令都会将命令结果数据返回给master。 指定returners时将会把数据也发送到指定的returner接口一份。

在调用命令时指定要使用的returners：
```bash
salt '*' test.version --return redis_return
```
这个命令将会把结果数据给 redis_return returner 一份。

可以同时指定多个 returners:
```bash
salt '*' test.version --return mongo_return,redis_return,cassandra_return
```
在这种情况下，将调用所有三个returners，并将test.version命令的数据发送给它们。

## WRITING A RETURNER
Returners也是一种Salt模块，支持将结果数据重定向到Salt Master以外的目标。

RETURNERS ARE EASY TO WRITE!

写一个salt returner很简单。

Returner是一个Python模块，至少包含一个`return`功能。 可以包含其他可选功能，以支持使用[master_job_cache](https://docs.saltstack.com/en/latest/ref/configuration/master.html#std:conf_master-master_job_cache)、[在外部系统中存储作业结果](https://docs.saltstack.com/en/latest/topics/jobs/external_cache.html#external-job-cache)以及[Event Returners](https://docs.saltstack.com/en/latest/ref/returners/index.html#event-returners)等功能。

**returner**

`returner`函数必须接受单个参数。 该参数包含来自被调用的minion函数的返回数据。 如果调用minion函数`test.version`，则参数的值将是字典类型。 从Salt master运行以下命令以获取一个字典类型参数的示例：
```bash
salt-call --local --metadata test.version --out=pprint
```
```python
import redis
import salt.utils.json

def returner(ret):
    '''
    Return information to a redis server
    '''
    # Get a redis connection
    serv = redis.Redis(
        host='redis-serv.example.com',
        port=6379,
        db='0')
    serv.sadd("%(id)s:jobs" % ret, ret['jid'])
    serv.set("%(jid)s:%(id)s" % ret, salt.utils.json.dumps(ret['return']))
    serv.sadd('jobs', ret['jid'])
    serv.sadd(ret['jid'], ret['id'])
```
上面设置为一个Returner将数据发送到Redis服务器，并将数据序列化为JSON后写入redis。

## USING CUSTOM RETURNER MODULES
将自定义returners放在master配置文件指定的`file_roots`中的`_returners/`目录中。

当调用以下任何一个函数时，都将触发分发自定义returners的操作：
- [state.apply](https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.state.html#salt.modules.state.apply_)
- [saltutil.sync_returners](https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.saltutil.html#salt.modules.saltutil.sync_returners)
- [saltutil.sync_all](https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.saltutil.html#salt.modules.saltutil.sync_all)

任何已经同步到minion上的名称与Salt的默认returners相同的自定义`returners`，都将取代具有相同名称的默认returners。

## NAMING THE RETURNER
请注意，returner的默认名称是其文件名（即foo.py成为返回者foo），但是可以使用[__virtual__](https://docs.saltstack.com/en/latest/ref/modules/index.html#virtual-modules)函数覆盖其名称。 一个很好的例子可以在[redis returner](https://github.com/saltstack/salt/tree/develop/salt/returners/redis_return.py)中找到，它名为`redis_return.py`，但只是简单地通过`redis`名称进行加载：
```python
try:
    import redis
    HAS_REDIS = True
except ImportError:
    HAS_REDIS = False

__virtualname__ = 'redis'

def __virtual__():
    if not HAS_REDIS:
        return False
    return __virtualname__
```

## MASTER JOB CACHE SUPPORT
master_job_cache, Storing Job Results in an External System, and Event Returners. Salt's master_job_cache allows returners to be used as a pluggable replacement for the Default Job Cache. In order to do so, a returner must implement the following functions:

Note

The code samples contained in this section were taken from the cassandra_cql returner.

prep_jid
Ensures that job ids (jid) don't collide, unless passed_jid is provided.

nocache is an optional boolean that indicates if return data should be cached. passed_jid is a caller provided jid which should be returned unconditionally.

def prep_jid(nocache, passed_jid=None):  # pylint: disable=unused-argument
    '''
    Do any work necessary to prepare a JID, including sending a custom id
    '''
    return passed_jid if passed_jid is not None else salt.utils.jid.gen_jid()
save_load
Save job information. The jid is generated by prep_jid and should be considered a unique identifier for the job. The jid, for example, could be used as the primary/unique key in a database. The load is what is returned to a Salt master by a minion. minions is a list of minions that the job was run against. The following code example stores the load as a JSON string in the salt.jids table.

import salt.utils.json

def save_load(jid, load, minions=None):
    '''
    Save the load to the specified jid id
    '''
    query = '''INSERT INTO salt.jids (
                 jid, load
               ) VALUES (
                 '{0}', '{1}'
               );'''.format(jid, salt.utils.json.dumps(load))

    # cassandra_cql.cql_query may raise a CommandExecutionError
    try:
        __salt__['cassandra_cql.cql_query'](query)
    except CommandExecutionError:
        log.critical('Could not save load in jids table.')
        raise
    except Exception as e:
        log.critical(
            'Unexpected error while inserting into jids: {0}'.format(e)
        )
        raise
get_load
must accept a job id (jid) and return the job load stored by save_load, or an empty dictionary when not found.

def get_load(jid):
    '''
    Return the load data that marks a specified jid
    '''
    query = '''SELECT load FROM salt.jids WHERE jid = '{0}';'''.format(jid)

    ret = {}

    # cassandra_cql.cql_query may raise a CommandExecutionError
    try:
        data = __salt__['cassandra_cql.cql_query'](query)
        if data:
            load = data[0].get('load')
            if load:
                ret = json.loads(load)
    except CommandExecutionError:
        log.critical('Could not get load from jids table.')
        raise
    except Exception as e:
        log.critical('''Unexpected error while getting load from
         jids: {0}'''.format(str(e)))
        raise

    return ret
EXTERNAL JOB CACHE SUPPORT
Salt's Storing Job Results in an External System extends the master_job_cache. External Job Cache support requires the following functions in addition to what is required for Master Job Cache support:

get_jid
Return a dictionary containing the information (load) returned by each minion when the specified job id was executed.

Sample:

{
    "local": {
        "master_minion": {
            "fun_args": [],
            "jid": "20150330121011408195",
            "return": "2018.3.4",
            "retcode": 0,
            "success": true,
            "cmd": "_return",
            "_stamp": "2015-03-30T12:10:12.708663",
            "fun": "test.version",
            "id": "master_minion"
        }
    }
}
get_fun
Return a dictionary of minions that called a given Salt function as their last function call.

Sample:

{
    "local": {
        "minion1": "test.version",
        "minion3": "test.version",
        "minion2": "test.version"
    }
}
get_jids
Return a list of all job ids.

Sample:

{
    "local": [
        "20150330121011408195",
        "20150330195922139916"
    ]
}
get_minions
Returns a list of minions

Sample:

{
     "local": [
         "minion3",
         "minion2",
         "minion1",
         "master_minion"
     ]
}
Please refer to one or more of the existing returners (i.e. mysql, cassandra_cql) if you need further clarification.

EVENT SUPPORT
An event_return function must be added to the returner module to allow events to be logged from a master via the returner. A list of events are passed to the function by the master.

The following example was taken from the MySQL returner. In this example, each event is inserted into the salt_events table keyed on the event tag. The tag contains the jid and therefore is guaranteed to be unique.

import salt.utils.json

def event_return(events):
 '''
 Return event to mysql server

 Requires that configuration be enabled via 'event_return'
 option in master config.
 '''
 with _get_serv(events, commit=True) as cur:
     for event in events:
         tag = event.get('tag', '')
         data = event.get('data', '')
         sql = '''INSERT INTO `salt_events` (`tag`, `data`, `master_id` )
                  VALUES (%s, %s, %s)'''
         cur.execute(sql, (tag, salt.utils.json.dumps(data), __opts__['id']))
TESTING THE RETURNER
The returner, prep_jid, save_load, get_load, and event_return functions can be tested by configuring the master_job_cache and Event Returners in the master config file and submitting a job to test.version each minion from the master.

Once you have successfully exercised the Master Job Cache functions, test the External Job Cache functions using the ret execution module.

salt-call ret.get_jids cassandra_cql --output=json
salt-call ret.get_fun cassandra_cql test.version --output=json
salt-call ret.get_minions cassandra_cql --output=json
salt-call ret.get_jid cassandra_cql 20150330121011408195 --output=json
EVENT RETURNERS
For maximum visibility into the history of events across a Salt infrastructure, all events seen by a salt master may be logged to one or more returners.

To enable event logging, set the event_return configuration option in the master config to the returner(s) which should be designated as the handler for event returns.

Note

Not all returners support event returns. Verify a returner has an event_return() function before using.

Note

On larger installations, many hundreds of events may be generated on a busy master every second. Be certain to closely monitor the storage of a given returner as Salt can easily overwhelm an underpowered server with thousands of returns.
