# MINION PRIMARY CONFIGURATION - Minion基础配置参数

## MASTER
Default: salt

设置为master节点的主机名或者是IP地址。IPv6地址的配置方式参照[ipv6](https://docs.saltstack.com/en/latest/ref/configuration/minion.html#std:conf_minion-ipv6)。
```yaml
master: salt
```

### MASTER:PORT SYNTAX
*New in version 2015.8.0.*

master选项也可以设置成ip:port的形式。
```yaml
master: localhost:1234
```

对于带端口的IPv6地址，请记住将IP地址放在中括号里，并将该行用单引号括起来使其成为字符串:
```yaml
master: '[2001:db8:85a3:8d3:1319:8a2e:370:7348]:1234'
```
> 如果在master配置文件中也使用master_port选项指定了端口，则在minion配置中的master_port设置将会被master端的配置覆盖。
### LIST OF MASTERS SYNTAX
这个master选项还可以用来定义一个master节点列表，以启用multi-master部署模式。

```yaml
master:
  - address1
  - address2
```

*Changed in version 2014.7.0: 可以动态配置master服务器。 master选项的值可以设置为将要执行的一个模块函数，并假设返回值是所需master服务的ip或主机名。 如果是指定的一个函数，则必须同时将master_type选项设置为func，以告诉minion该值要运行的是函数而不是一个域名。*

```yaml
master: module.function
master_type: func
```

此外，如果minion不使用multi-master部署模式，还可以将minion配置为使用一个master服务的地址列表作为failover列表，先尝试第一个地址，然后尝试第二个等，直到minion成功连接。 要启用此行为，请将master_type设置为failover：
```yaml
master:
  - address1
  - address2
master_type: failover
```

## IPV6
Default: None

是否应通过IPv6连接master服务器。 默认情况下，salt minion将尝试自动检测到master连接的IPv6连接。
```yaml
ipv6: True
```

## MASTER_URI_FORMAT
*New in version 2015.8.0.*

指定master服务地址的所使用的格式。 有效选项为default或ip_only。 如果指定了ip_only，则master地址将不会拆分为IP和PORT，因此请确保在master配置设置中仅设置了IP（或域名）。
```yaml
master_uri_format: ip_only
```

## MASTER_TOPS_FIRST
*New in version 2018.3.0.*

Default: False

使用Master Tops系统定义的SLS targets通常会安排在Top File中定义的任何匹配之后执行。 将此选项设置为True可使minion首先执行Master Tops states。
```yaml
master_tops_first: True
```

## MASTER_TYPE
*New in version 2014.7.0.*

Default: str

定义master的服务类型， 可以是 str, failover, func 或者 disable.
```yaml
master_type: failover
```
如果此选项设置为故障转移，则master选项必须定义为一个master服务地址的列表。 然后，minion将会按照列表中指定的顺序尝试每个master，直到它成功连接。 还必须设置master_alive_interval，这决定了minion将验证master的存活的频率。
```yaml
master_type: func
```
如果需要通过执行函数而不是读入静态master服务的值来动态分配master服务地址，请将其设置为func。 这可用于从执行模块管理minion的master设置。 只需更改模块中的算法以返回新的master ip/fqdn，重新启动minion，它就将会连接到新的master。

从版本2016.11.0开始，此选项可以设置为disable，并且minion永远不会尝试与master设备通信。 这对于运行无master服务的minion守护进程很有用。
```yaml
master_type: disable
```

## MAX_EVENT_SIZE
*New in version 2014.7.0.*

Default: 1048576

传递非常大的事件数据时可能会导致minion消耗大量内存。 此值调整允许进入minion事件总线的消息的最大大小。 该值以字节表示。
```yaml
max_event_size: 1048576
```

## ENABLE_LEGACY_STARTUP_EVENTS
*New in version 2019.2.0.*

Default: True

当一个minion启动时，它会在事件总线上发送一个通知，其标签如下所示：salt/minion/<minion_id>/start。 由于历史原因，minion还发送了一个类似的事件，其中包含如下事件标记：minion_start。 当有许多minions时，这种重复可能会在事件总线上造成很多混乱。 在minion配置中设置enable_legacy_startup_events：False以确保仅发送salt/minion/<minion_id>/start事件。 从Salt Sodium发行版本开始，此选项将默认为False。
```yaml
enable_legacy_startup_events: True
```

## MASTER_FAILBACK
*New in version 2016.3.0.*

Default: False

如果minion处于multi-master模式并且minion配置文件中`master_type`选项设置为failover，则此设置可以设置为True以强制minion在列表中第一个master服务器恢复服务时，将自己连接的master重新切换回第一个master服务上。
```yaml
master_failback: False
```

## MASTER_FAILBACK_INTERVAL
*New in version 2016.3.0.*

Default: 0

如果minion处于multi-master模式并且minion配置文件中`master_type`选项设置为failover，并且启用了`master_failback` 选项, 那么这个配置项将定义通过ping检测top master服务是否恢复的一个时间间隔，以秒为单位。
```yaml
master_failback_interval: 0
```

## MASTER_ALIVE_INTERVAL
Default: 0

配置minion以秒为单位验证当前master服务是否存活并正常返回响应的频率。 如果minion发现现有的master服务已经死了，它将尝试与列表中的下一个master建立连接。
```yaml
master_alive_interval: 30
```

## MASTER_SHUFFLE
*New in version 2014.7.0.*

*Deprecated since version 2019.2.0.*

Default: False

> Warning：
> 在 Salt 2019.2.0及以后版本中，该配置项已经被弃用，请使用random_master作为替代。

```yaml
master_shuffle: True
```

## RANDOM_MASTER
*New in version 2014.7.0.*

*Changed in version 2019.2.0: 如果第一个master服务器在故障后重新联机，master_failback选项可以与random_master一起使用，以强制minion恢复连接到列表中的第一个master服务器。 请注意，必须将master_type设置为failover才能使master_failback设置生效。*

Default: False

如果master配置项是一个服务地址的列表，则在minion尝试连接之前会先将其洗牌，以便在所有可用主服务器上平均分发minions。 这是使用Python的random.shuffle方法实现的。

如果在“master”参数设置中将多个master服务地址定义为一个列表，则默认行为始终是尝试按列出的顺序连接到它们。 如果random_master设置为True，则以上连接行为将会在Minion启动时执行一个随机化分配。 这有助于平衡分配执行salt-call请求的许多minions的负载，例如，来自cron作业。 如果仅列出一个master服务器，则此设置会被忽略并记录一条警告信息。
```yaml
random_master: True
```
> Note: 当同时启用了 failover, master_failback 和 random_master 配置项时，只有在选择 "secondary masters" 时才会执行随机分配操作。此时排在列表第一个的master会被random.shuffle 调用所忽略。

## RETRY_DNS
Default: 30

如果名称解析失败，使用该配置项设置在尝试解析master主机名之前等待的秒数。 默认为30秒。 如果minion应该关闭而不继续重试，则设置为零。
```yaml
retry_dns: 30
```

## RETRY_DNS_COUNT
*New in version 2018.3.4.*

Default: None

如果名称解析失败，则设置解析master主机名时要执行的尝试次数。 默认情况下，minion将无限期重试。
```yaml
retry_dns_count: 3
```

## MASTER_PORT
Default: 4506

指定master服务的端口，注意这需要与Salt Master服务器上的ret_port选项一致。
```yaml
master_port: 4506
```
## PUBLISH_PORT
Default: 4505

指定master发布服务器的端口，这需要与Salt master上的publish_port选项一致。
```yaml
publish_port: 4505
```

## SOURCE_INTERFACE_NAME
*New in version 2018.3.0.*

建立与Master的连接时使用的网卡接口名称。

> 如果在命名的网卡接口上配置了多个IP地址，则将选择第一个IP地址。 在这种情况下，为了更好的选择特定地址，请考虑使用source_address选项。

> 要使用命名网卡接口中的IPv6地址，请确保minion已经启用了配置项ipv6，即`ipv6：true`。

> 如果指定的网络接口是关闭状态的，minion将避免使用它，并且把自己的服务绑定到0.0.0.0（所有接口）。

> 警告 此选项需要所选传输使用的现有版本的基础库有以下要求：
 - zeromq requires pyzmq >= 16.0.1 and libzmq >= 4.1.6
 - tcp requires tornado >= 4.5

配置样例:
```yaml
source_interface_name: bond0.1234
```

## SOURCE_ADDRESS
*New in version 2018.3.0.*

将Minion连接到Master时要使用的源IP地址或域名。 有关与Master的IPv6连接，请参阅ipv6配置项。

> 警告 此选项需要所选传输使用的现有版本的基础库要求如下：
 - zeromq requires pyzmq >= 16.0.1 and libzmq >= 4.1.6
 - tcp requires tornado >= 4.5

配置样例:
```yaml
source_address: if-bond0-1234.sjc.us-west.internal
```

## SOURCE_RET_PORT
*New in version 2018.3.0.*

将Minion连接到Master ret服务器时要使用的本地源端口。

> 警告 此选项需要所选传输使用的现有版本的基础库有以下要求：
- zeromq requires pyzmq >= 16.0.1 and libzmq >= 4.1.6
- tcp requires tornado >= 4.5

配置样例:
```yaml
source_ret_port: 49017
```

## SOURCE_PUBLISH_PORT
*New in version 2018.3.0.*

将Minion连接到master发布服务器时要使用的本地源端口。

> 警告 此选项需要所选传输使用的现有版本的基础库有以下要求：
- zeromq requires pyzmq >= 16.0.1 and libzmq >= 4.1.6
- tcp requires tornado >= 4.5

配置样例:
```yaml
source_publish_port: 49018
```

## USER
Default: root

指定运行Salt 服务进程的系统用户。
```yaml
user: root
```

## SUDO_USER
Default: ''

用户通过sudo运行salt远程执行命令。 如果启用此选项，则将使用sudo更改执行远程命令的活动用户。 如果启用，则需要允许用户通过sudoers文件访问salt minion配置为运行的用户。 最常见的选择是使用root用户。 如果设置了此选项，则还应将用户选项设置为非root用户。 如果从root minion迁移到non root minion，则应清除minion缓存，并且需要将minion pki目录更改为新用户的所有权。
```yaml
sudo_user: root
```

## PIDFILE
Default: /var/run/salt-minion.pid

指定进程的pidfile路径。
```yaml
pidfile: /var/run/salt-minion.pid
```

## ROOT_DIR
Default: /

此目录将会被预先附加到以下选项的前面：pki_dir，cachedir，log_file，sock_dir和pidfile。
```yaml
root_dir: /
```

## CONF_FILE
Default: /etc/salt/minion

指定minion使用的配置文件。
```yaml
conf_file: /etc/salt/minion
```

## PKI_DIR
Default: /etc/salt/pki/minion

指定存放minion的公私密钥的路径。
```yaml
pki_dir: /etc/salt/pki/minion
```

## ID
Default: the system's hostname

> See also: [Salt Walkthrough](https://docs.saltstack.com/en/latest/topics/tutorials/walkthrough.html#minion-id-generation)
> 设置Salt Minion部分包含有关如何确定主机名的详细信息。

明确声明此minion使用的id。 由于Salt使用分离的id，因此可以在同一台机器上运行多个minions但具有不同的id。
```yaml
id: foo.bar.com
```

## MINION_ID_CACHING
*New in version 0.17.2.*

Default: True

当minion配置中没有静态定义minion的id时，将minion id缓存到文件中。 当从系统中自动获取minion id的方案改变时，此设置可防止潜在问题，这可能导致minion失去与master的连接。 要关闭minion id缓存，请将此配置设置为False。

For more information, please see [Issue #7558 ](https://github.com/saltstack/salt/issues/7558) and [Pull Request #8488](https://github.com/saltstack/salt/pull/8488).
```yaml
minion_id_caching: True
```

## APPEND_DOMAIN
Default: None

如果域名不存在，则将域附加到主机名。 这对于socket.getfqdn()调用实际上不会返回FQDN结果的系统（例如，Solaris）很有用。
```yaml
append_domain: foo.org
```

## MINION_ID_LOWERCASE
Default: False

在生成minion id时将其转换为小写。 在当一些主机以大写形式获得minion id时很有用。 但是启用了缓存功能的ID值将保持不变并且不会转换。
```yaml
minion_id_lowercase: True
```

## CACHEDIR
Default: /var/cache/salt/minion

Minion cache 数据的保存路径。

> 此目录可能包含敏感数据，因此应受到更多地保护。
```yaml
cachedir: /var/cache/salt/minion
```

## COLOR_THEME
Default: ""

指定用于彩色命令行输出的颜色主题的路径。
```yaml
color_theme: /etc/salt/color_theme
```

## APPEND_MINIONID_CONFIG_DIRS
Default: [] (the empty list) for regular minions, ['cachedir'] for proxy minions.

将minion_id附加到这些配置目录。 帮助在同一台机器上运行多个proxies和minions。 列表中允许的元素：pki_dir，cachedir，extension_modules。 通常不需要配置，除非需要在同一台机器上运行多个proxies和minions时。
```yaml
append_minionid_config_dirs:
  - pki_dir
  - cachedir
```

## VERIFY_ENV
Default: True

在启动时验证并设置配置目录的权限。
```yaml
verify_env: True
```
> Note
设置为True时，verify_env选项需要对配置目录（/etc/salt/）具有WRITE访问权限。 在某些情况下，例如挂载/etc/salt/作为模板，仅提供只读权限时，这将在调用state.apply时引发一个stack trace信息。

## CACHE_JOBS
Default: False

minion可以在本地缓存发送给它的作业的返回数据，这可以是在minion本地跟踪minion所执行的作业的一个方法。 默认情况下，此功能处于禁用状态，以将set cache_jobs设置为True以启用该功能。
```yaml
cache_jobs: False
```

## GRAINS
Default: (empty)

> See also: [Using grains in a state](https://docs.saltstack.com/en/latest/topics/grains/index.html#static-custom-grains)

静态地为minions定义一些grains变量。
```yaml
grains:
  roles:
    - webserver
    - memcache
  deployment: datacenter4
  cabinet: 13
  cab_u: 14-15
```

## GRAINS_CACHE
Default: False

minion可以在本地缓存grains数据，而不是每次引用grains时都要刷新数据。 默认情况下，此功能被禁用，要使用该功能请设置grains_cache为True。
```yaml
grains_cache: False
```

## GRAINS_DEEP_MERGE
*New in version 2016.3.0.*

Default: False

使用此选项可以合并grains而不是覆盖。 这允许通过自定义grains来定义字典grains的不同子值。 默认情况下，此功能处于禁用状态，要使用该功能请设置 grains_deep_merge设置为True。
```yaml
grains_deep_merge: False
```
例如，下面的自定义grains函数：
```yaml
def custom1_k1():
    return {'custom1': {'k1': 'v1'}}

def custom1_k2():
    return {'custom1': {'k2': 'v2'}}
```
不使用 grains_deep_merge功能时, 结果将是:
```yaml
custom1:
  k1: v1
```
使用 grains_deep_merge时, 结果将是:
```yaml
custom1:
  k1: v1
  k2: v2
```

## GRAINS_REFRESH_EVERY
Default: 0

grain_refresh_every设置允许minion定期检查其grains以查看它们是否已更改，如果是，则通知主机获取新的grains值。 此操作的系统负载略大，因此应注意不要将此值设置得太低。

> 注意：此值以分钟表示。

10分钟会是一个比较合理的取值。
```yaml
grains_refresh_every: 0
```

## METADATA_SERVER_GRAINS
New in version 2017.7.0.

Default: False

Set this option to enable gathering of cloud metadata from http://169.254.169.254/latest for use in grains (see here for more information).

metadata_server_grains: True
FIBRE_CHANNEL_GRAINS
Default: False

The fibre_channel_grains setting will enable the fc_wwn grain for Fibre Channel WWN's on the minion. Since this grain is expensive, it is disabled by default.

fibre_channel_grains: True
ISCSI_GRAINS
Default: False

The iscsi_grains setting will enable the iscsi_iqn grain on the minion. Since this grain is expensive, it is disabled by default.

iscsi_grains: True
MINE_ENABLED
New in version 2015.8.10.

Default: True

Determines whether or not the salt minion should run scheduled mine updates. If this is set to False then the mine update function will not get added to the scheduler for the minion.

mine_enabled: True
MINE_RETURN_JOB
New in version 2015.8.10.

Default: False

Determines whether or not scheduled mine updates should be accompanied by a job return for the job cache.

mine_return_job: False
MINE_FUNCTIONS
Default: Empty

Designate which functions should be executed at mine_interval intervals on each minion. See this documentation on the Salt Mine for more information. Note these can be defined in the pillar for a minion as well.

example minion configuration file
mine_functions:
  test.ping: []
  network.ip_addrs:
    interface: eth0
    cidr: '10.0.0.0/8'
MINE_INTERVAL
Default: 60

The number of minutes between mine updates.

mine_interval: 60
SOCK_DIR
Default: /var/run/salt/minion

The directory where Unix sockets will be kept.

sock_dir: /var/run/salt/minion
ENABLE_GPU_GRAINS
Default: True

Enable GPU hardware data for your master. Be aware that the minion can take a while to start up when lspci and/or dmidecode is used to populate the grains for the minion, so this can be set to False if you do not need these grains.

enable_gpu_grains: False
OUTPUTTER_DIRS
Default: []

A list of additional directories to search for salt outputters in.

outputter_dirs: []
BACKUP_MODE
Default: ''

Make backups of files replaced by file.managed and file.recurse state modules under cachedir in file_backup subdirectory preserving original paths. Refer to File State Backups documentation for more details.

backup_mode: minion
ACCEPTANCE_WAIT_TIME
Default: 10

The number of seconds to wait until attempting to re-authenticate with the master.

acceptance_wait_time: 10
ACCEPTANCE_WAIT_TIME_MAX
Default: 0

The maximum number of seconds to wait until attempting to re-authenticate with the master. If set, the wait will increase by acceptance_wait_time seconds each iteration.

acceptance_wait_time_max: 0
REJECTED_RETRY
Default: False

If the master rejects the minion's public key, retry instead of exiting. Rejected keys will be handled the same as waiting on acceptance.

rejected_retry: False
RANDOM_REAUTH_DELAY
Default: 10

When the master key changes, the minion will try to re-auth itself to receive the new master key. In larger environments this can cause a syn-flood on the master because all minions try to re-auth immediately. To prevent this and have a minion wait for a random amount of time, use this optional parameter. The wait-time will be a random number of seconds between 0 and the defined value.

random_reauth_delay: 60
MASTER_TRIES
New in version 2016.3.0.

Default: 1

The number of attempts to connect to a master before giving up. Set this to -1 for unlimited attempts. This allows for a master to have downtime and the minion to reconnect to it later when it comes back up. In 'failover' mode, which is set in the master_type configuration, this value is the number of attempts for each set of masters. In this mode, it will cycle through the list of masters for each attempt.

master_tries is different than auth_tries because auth_tries attempts to retry auth attempts with a single master. auth_tries is under the assumption that you can connect to the master but not gain authorization from it. master_tries will still cycle through all of the masters in a given try, so it is appropriate if you expect occasional downtime from the master(s).

master_tries: 1
AUTH_TRIES
New in version 2014.7.0.

Default: 7

The number of attempts to authenticate to a master before giving up. Or, more technically, the number of consecutive SaltReqTimeoutErrors that are acceptable when trying to authenticate to the master.

auth_tries: 7
AUTH_TIMEOUT
New in version 2014.7.0.

Default: 60

When waiting for a master to accept the minion's public key, salt will continuously attempt to reconnect until successful. This is the timeout value, in seconds, for each individual attempt. After this timeout expires, the minion will wait for acceptance_wait_time seconds before trying again. Unless your master is under unusually heavy load, this should be left at the default.

auth_timeout: 60
AUTH_SAFEMODE
New in version 2014.7.0.

Default: False

If authentication fails due to SaltReqTimeoutError during a ping_interval, this setting, when set to True, will cause a sub-minion process to restart.

auth_safemode: False
PING_INTERVAL
Default: 0

Instructs the minion to ping its master(s) every n number of minutes. Used primarily as a mitigation technique against minion disconnects.

ping_interval: 0
RANDOM_STARTUP_DELAY
Default: 0

The maximum bound for an interval in which a minion will randomly sleep upon starting up prior to attempting to connect to a master. This can be used to splay connection attempts for cases where many minions starting up at once may place undue load on a master.

For example, setting this to 5 will tell a minion to sleep for a value between 0 and 5 seconds.

random_startup_delay: 5
RECON_DEFAULT
Default: 1000

The interval in milliseconds that the socket should wait before trying to reconnect to the master (1000ms = 1 second).

recon_default: 1000
RECON_MAX
Default: 10000

The maximum time a socket should wait. Each interval the time to wait is calculated by doubling the previous time. If recon_max is reached, it starts again at the recon_default.

Short example:
reconnect 1: the socket will wait 'recon_default' milliseconds
reconnect 2: 'recon_default' * 2
reconnect 3: ('recon_default' * 2) * 2
reconnect 4: value from previous interval * 2
reconnect 5: value from previous interval * 2
reconnect x: if value >= recon_max, it starts again with recon_default
recon_max: 10000
RECON_RANDOMIZE
Default: True

Generate a random wait time on minion start. The wait time will be a random value between recon_default and recon_default + recon_max. Having all minions reconnect with the same recon_default and recon_max value kind of defeats the purpose of being able to change these settings. If all minions have the same values and the setup is quite large (several thousand minions), they will still flood the master. The desired behavior is to have time-frame within all minions try to reconnect.

recon_randomize: True
LOOP_INTERVAL
Default: 1

The loop_interval sets how long in seconds the minion will wait between evaluating the scheduler and running cleanup tasks. This defaults to 1 second on the minion scheduler.

loop_interval: 1
PUB_RET
Default: True

Some installations choose to start all job returns in a cache or a returner and forgo sending the results back to a master. In this workflow, jobs are most often executed with --async from the Salt CLI and then results are evaluated by examining job caches on the minions or any configured returners. WARNING: Setting this to False will disable returns back to the master.

pub_ret: True
RETURN_RETRY_TIMER
Default: 5

The default timeout for a minion return attempt.

return_retry_timer: 5
RETURN_RETRY_TIMER_MAX
Default: 10

The maximum timeout for a minion return attempt. If non-zero the minion return retry timeout will be a random int between return_retry_timer and return_retry_timer_max

return_retry_timer_max: 10
CACHE_SREQS
Default: True

The connection to the master ret_port is kept open. When set to False, the minion creates a new connection for every return to the master.

cache_sreqs: True
IPC_MODE
Default: ipc

Windows platforms lack POSIX IPC and must rely on slower TCP based inter- process communications. Set ipc_mode to tcp on such systems.

ipc_mode: ipc
TCP_PUB_PORT
Default: 4510

Publish port used when ipc_mode is set to tcp.

tcp_pub_port: 4510
TCP_PULL_PORT
Default: 4511

Pull port used when ipc_mode is set to tcp.

tcp_pull_port: 4511
TRANSPORT
Default: zeromq

Changes the underlying transport layer. ZeroMQ is the recommended transport while additional transport layers are under development. Supported values are zeromq, raet (experimental), and tcp (experimental). This setting has a significant impact on performance and should not be changed unless you know what you are doing!

transport: zeromq
SYNDIC_FINGER
Default: ''

The key fingerprint of the higher-level master for the syndic to verify it is talking to the intended master.

syndic_finger: 'ab:30:65:2a:d6:9e:20:4f:d8:b2:f3:a7:d4:65:50:10'
HTTP_CONNECT_TIMEOUT
New in version 2019.2.0.

Default: 20

HTTP connection timeout in seconds. Applied when fetching files using tornado back-end. Should be greater than overall download time.

http_connect_timeout: 20
HTTP_REQUEST_TIMEOUT
New in version 2015.8.0.

Default: 3600

HTTP request timeout in seconds. Applied when fetching files using tornado back-end. Should be greater than overall download time.

http_request_timeout: 3600
PROXY_HOST
Default: ''

The hostname used for HTTP proxy access.

proxy_host: proxy.my-domain
PROXY_PORT
Default: 0

The port number used for HTTP proxy access.

proxy_port: 31337
PROXY_USERNAME
Default: ''

The username used for HTTP proxy access.

proxy_username: charon
PROXY_PASSWORD
Default: ''

The password used for HTTP proxy access.

proxy_password: obolus
NO_PROXY
New in version 2019.2.0.

Default: []

List of hosts to bypass HTTP proxy

Note

This key does nothing unless proxy_host etc is configured, it does not support any kind of wildcards.

no_proxy: [ '127.0.0.1', 'foo.tld' ]
